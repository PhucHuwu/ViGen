name: Auto Build and Release

on:
    push:
        branches:
            - main
        tags-ignore:
            - "v*"

permissions:
    contents: write

jobs:
    create-release:
        name: Create Release
        runs-on: ubuntu-latest
        outputs:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            new_tag: ${{ steps.tag_version.outputs.new_tag }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Bump version and push tag
              id: tag_version
              uses: mathieudutour/github-tag-action@v6.2
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  default_bump: patch
                  release_branches: main

            - name: Build Changelog
              id: build_changelog
              uses: mikepenz/release-changelog-builder-action@v4
              with:
                  configuration: |
                      {
                        "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
                        "categories": [
                          {
                              "title": "## üöÄ Features",
                              "labels": ["feature", "feat"]
                          },
                          {
                              "title": "## üêõ Fixes",
                              "labels": ["fix", "bug"]
                          },
                          {
                              "title": "## üß™ Tests",
                              "labels": ["test"]
                          }
                        ]
                      }
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Create Release
              id: create_release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.tag_version.outputs.new_tag }}
                  name: Release ${{ steps.tag_version.outputs.new_tag }}
                  body: ${{ steps.build_changelog.outputs.changelog }}
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    build:
        name: Build (${{ matrix.os }})
        needs: create-release
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: windows-latest
                      artifact_name: ViGen_Windows.exe
                    - os: macos-15 # Intel (Updated from macos-13)
                      artifact_name: ViGen_macOS_Intel.zip
                    - os: macos-latest # Apple Silicon (M1)
                      artifact_name: ViGen_macOS_Silicon.zip

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install pyinstaller
                  pip install PyQt6 qasync qt-material "google-genai" "langchain" "langchain-community" "langchain-core" "langchain-openai" "moviepy" "pillow" "pydantic" "pyyaml" "tenacity" "tqdm" "requests" "httpx" "python-dotenv"

            # Windows Build
            - name: Build EXE (Windows)
              if: runner.os == 'Windows'
              run: |
                  pyinstaller --onefile --windowed --name ViGen --icon "gui/assets/logo.ico" gui/main.py

            # macOS Build
            - name: Build App (macOS)
              if: runner.os == 'macOS'
              run: |
                  # Create ICNS from PNG using Python Pillow (more robust than sips)
                  python -c "from PIL import Image; img = Image.open('gui/assets/logo.png'); img.save('ViGen.icns', format='ICNS', sizes=[(16,16), (32,32), (48,48), (64,64), (128,128), (256,256), (512,512), (1024,1024)])"

                  # Build .app bundle
                  pyinstaller --windowed --name ViGen --icon ViGen.icns gui/main.py

                  # Zip the app
                  cd dist
                  zip -r ../${{ matrix.artifact_name }} ViGen.app

            - name: Rename Windows Asset
              if: runner.os == 'Windows'
              run: |
                  mv dist/ViGen.exe ${{ matrix.artifact_name }}

            - name: Upload Release Asset
              uses: softprops/action-gh-release@v2
              if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'push'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ needs.create-release.outputs.new_tag }}
                  files: ${{ runner.os == 'Windows' && matrix.artifact_name || matrix.artifact_name }}
