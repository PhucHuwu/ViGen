name: Auto Build and Release

on:
    push:
        branches:
            - main
        tags-ignore:
            - "v*" # Avoid infinite loop if action pushes a tag

permissions:
    contents: write

jobs:
    build-and-release:
        name: Build Windows EXE and Release
        runs-on: windows-latest

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Required for version determination and changelog

            - name: Bump version and push tag
              id: tag_version
              uses: mathieudutour/github-tag-action@v6.2
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  default_bump: patch
                  release_branches: main

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install pyinstaller
                  # Core libraries used in the project
                  pip install PyQt6 qasync qt-material "google-genai" "langchain" "langchain-community" "langchain-core" "langchain-openai" "moviepy" "pillow" "pydantic" "pyyaml" "tenacity" "tqdm" "requests" "httpx" "python-dotenv"

            - name: Build EXE with PyInstaller
              run: |
                  # Build ViGen.exe, windowed (no console), including icon
                  pyinstaller --onefile --windowed --name ViGen --icon "gui/assets/logo.ico" gui/main.py

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.tag_version.outputs.new_tag }}
                  name: Release ${{ steps.tag_version.outputs.new_tag }}
                  body: ${{ steps.tag_version.outputs.changelog }}
                  files: |
                      dist/ViGen.exe
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
