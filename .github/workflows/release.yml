name: Auto Build and Release

on:
    push:
        branches:
            - main
        tags-ignore:
            - "v*"

permissions:
    contents: write

jobs:
    prepare-release:
        name: Prepare Release
        runs-on: ubuntu-latest
        outputs:
            new_tag: ${{ steps.tag_version.outputs.new_tag }}
            changelog: ${{ steps.build_changelog.outputs.changelog }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Bump version and push tag
              id: tag_version
              uses: mathieudutour/github-tag-action@v6.2
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  default_bump: patch
                  release_branches: main

            - name: Build Changelog
              id: build_changelog
              uses: mikepenz/release-changelog-builder-action@v4
              with:
                  configuration: |
                      {
                        "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
                        "categories": [
                          {
                              "title": "## üöÄ Features",
                              "labels": ["feature", "feat"]
                          },
                          {
                              "title": "## üêõ Fixes",
                              "labels": ["fix", "bug"]
                          },
                          {
                              "title": "## üß™ Tests",
                              "labels": ["test"]
                          }
                        ]
                      }
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    build-windows:
        name: Build Windows
        runs-on: windows-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install pyinstaller
                  pip install PyQt6 qasync qt-material "google-genai" "langchain" "langchain-community" "langchain-core" "langchain-openai" "moviepy" "pillow" "pydantic" "pyyaml" "tenacity" "tqdm" "requests" "httpx" "python-dotenv"

            - name: Build EXE
              run: |
                  pyinstaller --onefile --windowed --name ViGen --icon "gui/assets/logo.ico" gui/main.py

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ViGen_Windows
                  path: dist/ViGen.exe

    build-macos-intel:
        name: Build macOS Intel
        runs-on: macos-13 # Native Intel Runner
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install pyinstaller
                  pip install PyQt6 qasync qt-material "google-genai" "langchain" "langchain-community" "langchain-core" "langchain-openai" "moviepy" "pillow" "pydantic" "pyyaml" "tenacity" "tqdm" "requests" "httpx" "python-dotenv"

            - name: Create Icon
              run: |
                  python -c "from PIL import Image; img = Image.open('gui/assets/logo.png'); img.save('ViGen.icns', format='ICNS', sizes=[(16,16), (32,32), (48,48), (64,64), (128,128), (256,256), (512,512), (1024,1024)])"

            - name: Build App
              run: |
                  pyinstaller --windowed --name ViGen --icon ViGen.icns gui/main.py

            - name: Zip App
              run: |
                  cd dist
                  zip -r ViGen_macOS_Intel.zip ViGen.app

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ViGen_macOS_Intel
                  path: dist/ViGen_macOS_Intel.zip

    build-macos-silicon:
        name: Build macOS Silicon
        runs-on: macos-latest # Native ARM Runner
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install pyinstaller
                  pip install PyQt6 qasync qt-material "google-genai" "langchain" "langchain-community" "langchain-core" "langchain-openai" "moviepy" "pillow" "pydantic" "pyyaml" "tenacity" "tqdm" "requests" "httpx" "python-dotenv"

            - name: Create Icon
              run: |
                  python -c "from PIL import Image; img = Image.open('gui/assets/logo.png'); img.save('ViGen.icns', format='ICNS', sizes=[(16,16), (32,32), (48,48), (64,64), (128,128), (256,256), (512,512), (1024,1024)])"

            - name: Build App
              run: |
                  pyinstaller --windowed --name ViGen --icon ViGen.icns gui/main.py

            - name: Zip App
              run: |
                  cd dist
                  zip -r ViGen_macOS_Silicon.zip ViGen.app

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ViGen_macOS_Silicon
                  path: dist/ViGen_macOS_Silicon.zip

    release:
        name: Publish Release
        needs: [prepare-release, build-windows, build-macos-intel, build-macos-silicon]
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Download Windows Artifact
              uses: actions/download-artifact@v4
              with:
                  name: ViGen_Windows
                  path: output

            - name: Download macOS Intel Artifact
              uses: actions/download-artifact@v4
              with:
                  name: ViGen_macOS_Intel
                  path: output

            - name: Download macOS Silicon Artifact
              uses: actions/download-artifact@v4
              with:
                  name: ViGen_macOS_Silicon
                  path: output

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ needs.prepare-release.outputs.new_tag }}
                  name: Release ${{ needs.prepare-release.outputs.new_tag }}
                  body: ${{ needs.prepare-release.outputs.changelog }}
                  files: |
                      output/ViGen.exe
                      output/ViGen_macOS_Intel.zip
                      output/ViGen_macOS_Silicon.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
